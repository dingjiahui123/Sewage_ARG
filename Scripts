#The Illumina data were filtered using fastp v0.23.4 with default parameters, then remove human sequences using bowtie2 v2.5.4.
fastp -i short_raw_1.fastq.gz -I short_raw_2.fastq.gz -o short_filtered_1.fastq.gz -O short_filtered_2.fastq.gz
bowtie2 -x T2T-CHM13_database -1 short_filtered_1.fastq.gz -2 short_filtered_2.fastq.gz -S short_align.sam
samtools view -bS short_align.sam | samtools view -b -f 12 -F 256 > short_non_human.bam
samtools sort -n short_non_human.bam -o short_non_human_sorted.bam
samtools fastq short_non_human_sorted.bam -1 short_clean_1.fastq.gz -2 short_clean_2.fastq.gz -0 /dev/null -s /dev/null -n -c 6

#For Illumina data, ARGs were quantified using ARGs_OAP v3.2.2 with default settings.
args_oap stage_one -i input_file -o output_file -f fastq.gz
args_oap stage_two -i output_file

#For Illumina data, MGEs were quantified using ARGs_OAP v3.2.2 by replacing the reference database with the MGE database (Ellabaan, M.M.H., Munck, C., Porse, A. et al. Forecasting the dissemination of antibiotic resistance genes across bacterial genomes. Nat Commun 12, 2435 (2021). ).
args_oap make_db -i MGE_database.fasta
echo '>level1' | cat - MGE_database.fasta | grep '^>' | cut -d ' ' -f 1 | cut -c2- > structure.txt
args_oap stage_one -i input_file -o output_file -f fastq.gz --database MGE_database.fasta
args_oap stage_two -i output_file --database MGE_database.fasta --structure1 structure.txt

#The Nanopore data were filtered using NanoFilt v2.8.0 to remove reads shorter than 1000 bp, and low-quality reads with average quality scores of less than 10, then remove human sequences using minimap2 v2.26.
gunzip -c long_raw.fastq.gz | NanoFilt -q 10 -l 1000| gzip > long_filtered.fastq.gz
minimap2 -ax map-ont T2T-CHM13_database long_filtered.fastq.gz -o long_align.sam
samtools view -buSh -f 4 long_align.sam | samtools fastq - | gzip -c - > long_clean.fastq.gz

#For Nanopore data, ARGs were identified by aligning reads against the SARG v3.2.2 database using the BLASTX function of DIAMOND v2.1.8 at a maximum e-value of 1e-20, a minimum identity of 80%, and a minimum subject coverage of 80%.
diamond makedb --in SARG_database.fasta --db SARG_database.dmnd
diamond blastx --db SARG_database.dmnd --query long_clean.fastq.gz --out long_ARG.txt --evalue 1e-20 --subject-cover 80 --id 80 --range-culling -F 15 --range-cover 25 --max-hsps 0 --max-target-seqs 1 --sensitive

#For Nanopore data, MGEs were identified by aligning reads against the above mentioned MGE database using minimap2 v2.26 with a minimum identity of 80% and a minimum subject coverage of 80%.
minimap2 -cx map-ont MGE_database.fasta long_clean.fastq.gz -o long_MGE.paf
grep "tp:A:P" long_MGE.paf > long_MGE_primary.paf; 
awk '{print 100*(($9-$8)/$7)}' long_MGE_primary.paf|paste long_MGE_primary.paf - > long_MGE_primary_subcov.paf
awk '{print 100*($10/$11)}' long_MGE_primary_subcov.paf|paste long_MGE_primary_subcov.paf - > long_MGE_primary_subcov_id.paf
awk '$(NF-1)>=80 && $NF>=80 {print}' long_MGE_primary_subcov_id.paf> long_MGE_primary_subcov_id_80_80.txt 

#The microbial compositions for Illumina data and ARG host for Nanopore data were classified using Kraken2 v2.1.3 with GTDB (release 207).
kraken2 --gzip-compressed input.fastq.gz --db GTDB_r207 --report kraken.K2report --output kraken.output

#For homology analysis, the Nanopore reads were de novo assembled using Flye v2.9.2 with the mode “--meta”, followed by three cycles of polishing using Illumina reads with Pilon v1.24 for read correction.
flye --meta --nano-hq long_clean.fastq.gz -i 1 -g 5m -o Flye_output/
bowtie2-build assembly.fasta assembly.index
bowtie2 -x assembly.index -1 short_clean_1.fastq -2 short_clean_2.fastq -S assembly.sam
samtools view -Sub assembly.sam > assembly.bam
samtools sort assembly.bam -O BAM -o assembly.sort.bam
samtools index assembly.sort.bam
java -jar pilon-1.24.jar --fix bases --genome assembly.fasta  --bam assembly.sort.bam --outdir polished_assembly

#The open reading frames (ORFs) of the corrected contigs were predicted using Prodigal v2.6.3 with the “-p meta” option. 
prodigal -a pilon_orf.pep -d pilon_orf.cds -f gff -g 11  -o pilon_orf.gff -p meta -s pilon_orf.stat -i pilon.fasta

#The ARGs-like ORFs were identified using the BLASTP function of DIAMOND v2.1.8 against the SARG v3.2.2 database at e-value ≤ 1e-20, identity ≥ 80%, and subject coverage ≥ 80%.
diamond blastp --db SARG_database.dmnd --query pilon_orf.pep --out pilon_orf_ARG.txt --evalue 1e-20 --subject-cover 80 --id 80 --max-target-seqs 1 --sensitive --max-hsps 0

#The sequences of ARGs were subjected to multiple alignment using Clustal Omega v1.2.4, and the maximum likelihood tree was then constructed using IQ-TREE2 v2.3.4. 
clustalo -i ARG_orf.pep > ARG_align.pep
iqtree2 -s ARG_align.pep -m MFP --alrt 1000 -B 1000 -T 40
